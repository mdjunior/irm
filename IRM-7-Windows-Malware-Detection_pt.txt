Metodologia de Resposta a Incidentes

IRM # 7
Detecção de malware em Windows
Análise ao vivo em um computador suspeito
___________________________________________________

E-Mail: 
Web: 
Twitter: 

0 - Resumo

Esta metodologia de Resposta a Incidentes é um folha de dicas dedicada a tratadores de incidentes que estão investigando um problema de segurança específico.

Quem deve usar as folhas de IRM?

• Administradores
• Security Operation Center, ou CSIRTs
• CISOs e suplentes
• CERT (Computer Emergency Response Team)

Lembre-se: Se você enfrentar um incidente, siga a IRM, tome notas e não entre em pânico. Contate seu CERT imediatamente, se necessário.

0.1 - Tratamento das etapas do Incidente

6 passos são definidos para lidar com incidentes de segurança

Preparação: se preparar para lidar com o incidente
Identificação: detectar o incidente
Contenção: limitar o impacto do incidente
Correção: remover a ameaça
Recuperação: recuperar para um estágio normal
Resultados Finais: elaborar e melhorar o processo

O IRM fornece informações detalhadas para cada etapa.

Este documento é de uso público

1 - Preparação

■ O acesso físico ao sistema suspeito deve ser oferecido ao investigador forense. 
■ Um bom conhecimento das atividades habituais de rede e locais do computador são apreciados. Você deve ter um arquivo que descreve a atividade das portas usualmente, para ter uma base de comparação com o estado atual.
■ Um bom conhecimento dos serviços comuns utilizados e aplicativos instalados é necessário. Não hesite em pedir a um especialista do Windows a sua assistência, quando aplicável.
 
2 - Identificação

2.1 - Sinais gerais de presença de malwares no ambiente de trabalho

Diversas dicas podem sugerir que o sistema pode estar comprometido por um malware:

■ Antivirus anunciando um alerta ou não conseguindo atualizar suas assinaturas ou parar de executar ou mesmo ficar incapaz de executar manualmente
■ Atividade de disco rígido incomus: o disco rígido faz operações enormes em momentos inesperados.
■ Computador excepcionalmente lento: enquanto ele estava funcionando normalmente a uma boa velocidade, ele ficou mais lento recentemente
■ Atividade de rede incomum: conexão com a Internet é muito lenta a maior parte do tempo navegando.
■ O computador reinicia sem razão.
■ Algumas aplicações estão caindo, inesperadamente.
■ Janelas pop-up estão aparecendo enquanto navega na web. (Às vezes mesmo sem navegação)
■ O seu endereço IP (se estático) está na lista negra em uma ou mais Black Lists.
■ Pessoas estão reclamando que você está enviando emails ou chamando elas por IM, etc, enquanto você não fez isso.

Ações abaixo utiliza ferramentas padrão do Windows. Os usuários autorizados podem usar o Sysinternals Troubleshooting Utilities para executar essas tarefas.

2.2 - Contas Incomuns

Olhe para as contas incomuns e desconhecidos criado, especialmente no grupo de administradores:
C: \> lusrmgr.msc

2.3 - Arquivos incomuns

■ Procure arquivos incomuns grandes nos dispositivos de armazenamento. Maiores que 10MB parecem ser razoáveis.
■ Procure arquivos incomuns adicionados recentemente em pastas do sistema, especialmente em C: \ WINDOWS \ system32.
■ Procure arquivos usando o atributo "hidden":
C: \> dir / S / A: H

2.4 - Entradas do Registro Incomuns

Procure programas incomuns executados no momento da inicialização no registro do Windows, especialmente em:
HKLM \ Software \ Microsoft \ Windows \ CurrentVersion \ Run
HKLM \ Software \ Microsoft \ Windows \ CurrentVersion \ Runonce
HKLM \ Software \ Microsoft \ Windows \ CurrentVersion \ RunOnce
HKLM \ Software \ Microsoft \ Windows NT \ CurrentVersion
\ Winlogon
Verifique se há as mesmas entradas na HKCU

2.5 - Processos e Serviços Incomuns

■ Verifique todos os processos em execução para as entradas incomuns / desconhecidas, especialmente com os processos com nome de usuário "SYSTEM" e "Administrador":
C: \> taskmgr.exe
(Ou tlisk, tasklist dependendo versão do Windows)
■ Procure por serviços incomuns / inesperados de rede instalados e inicializados:
C: \> services.msc
C: \> net start
Nota: um bom conhecimento dos serviços usual é necessária.

2.6 - Atividade de Rede Incomum

■ Verificar se há compartilhamentos de arquivos e verificar se cada um está ligado a uma atividade normal:
C: \> net view \ \ 127.0.0.1
■ Olhe para as sessões abertas na máquina:
C: \> net session
■ Veja os compartilhamentos que máquina disponibilizou a outros sistemas:
C: \> net use
■ Verifique se há alguma ligação Netbios suspeita:
C: \> nbtstat -S
■ Procure qualquer atividade suspeita nas portas do sistema TCP / IP:
C: \> netstat -na 5 (-na 5 define o intervalo de atualização para 5 segundos)
Use a flag "-o" para Windows XP/2003 para ver o proprietário de cada processo:
C: \> netstat -nao 5
■ Utilize um sniffer (Wireshark, tcpdump, etc) e veja se há tentativas incomum de conexões ou de sistemas remotos. Se nenhuma atividade suspeita é testemunhada, use o sniffer enquanto navega em alguns sites sensíveis (website de internet banking, por exemplo) e veja se existe alguma atividade incomum de rede.
Nota: Um bom conhecimento da atividade da rede legítima é necessário.

2.7 - Tarefas automatizadas incomuns

■ Olhe para a lista de tarefas agendadas para qualquer entrada incomum:
C: \> at
No Windows 2003/XP: C: \> schtasks
■ Além disso, verifique os diretórios "autostart" usuário:
C: \ Documents and Settings \ usuário \ Start Menu \ Programs \ Startup
C: \ WinNT \ Profiles \ user \ Menu Iniciar \ Programas \ Startup

2.8 - Entradas de log incomuns

■ Assista seus arquivos de log para entradas incomuns:
C: \> eventvwr.msc
■ Pesquise para eventos como o seguinte:
"Serviço Log de eventos foi interrompido"
"Windows File Protection não está ativo"
"O <name> arquivo protegido do sistema não foi restaurado ao seu original "
"Serviço de Telnet foi iniciado com êxito"
■ Cuidado com os arquivos de log do firewall (se houver) para atividades suspeitas.
Você também pode usar um antivírus atualizado para identificar o malware no sistema, mas esteja ciente de que poderia destruir provas.

Em caso nada suspeito foi encontrado, isso não significa que o sistema não está infectado. Um rootkit pode ser ativo, por exemplo, distraindo todas as suas ferramentas de dar bons resultados.
A investigação forense ainda pode ser feito no sistema enquanto ele está desligado, se o sistema ainda é suspeito. O caso ideal é fazer uma cópia bit a bit do disco rígido que contém o sistema, e analisar a cópia usando ferramentas forenses como EnCase ou X-Ways.


3 - Contenção

Puxar o plugue de rede, fisicamente, para evitar mais infecções na rede e para parar a provável ação ilegal que está sendo feita a partir do seu computador (o malware pode enviar spam em massa, participar de ataque DDoS ou armazenar arquivos ilegais no sistema, por exemplo).

Enviar os binários suspeito para o seu CERT, ou um pedido de ajuda ao CERT se não tiver certeza sobre o malware. O CERT deve ser capaz de isolar o conteúdo malicioso e pode enviá-lo para todas as empresas AV, especialmente com os fornecedores da sua empresa. (A melhor maneira é criar um arquivo compactado do binário suspeito, usando uma senha criptografada).


4 - Remediação

Reiniciar a partir de um live CD e fazer backup de todos os dados importantes com suporte de um armazenamento externo. Se não tiver certeza, leve o seu disco rígido para o helpdesk e peça-lhes para fazer uma cópia do conteúdo importante.
Remova os binários e as entradas de registro relacionadas.
■ Encontre as melhores práticas para remover o malware. Eles geralmente podem ser encontrados em sites de empresas de antivírus.
■ Executar uma verificação antivírus on-line.
■ Iniciar um live CD baseado no Bart PE contendo ferramentas de desinfecção (pode ser baixado de sites de AV), ou um live CD de anti-vírus dedicado.


5 - Recuperação

Se possível reinstale o sistema operacional, aplicações e restaure os dados do usuário a partir de backups confiáveis.

No caso de o computador não poder ser reinstalado completamente:
■ Restaurar arquivos que poderiam ter sido corrompidos pelo malware, especialmente arquivos do sistema.
■ Reinicie a máquina depois de toda a limpeza ter sido feita, e verifique a saude do sistema, fazendo uma verificação de vírus de todo o sistema, discos rígidos e memória.

6 - Resultados finais

6,1 - Relatório

Um relatório de incidente deve ser escrito e disponibilizado a todos os envolvidos.
Os seguintes temas devem ser descritos:
■ Detecção inicial.
■ Ações e cronogramas.
■ O que deu certo.
■ O que deu errado.
■ Custo de Incidentes.

6.2 - Capitalize

Ações para melhorar os processos de detecção de malware em Windows devem ser definidos para capitalizar sobre essa experiência.

